# Evolution of transcriptional networks in Daphnia

Code for Frisch, Becker and Wojewodzic paper Titled: "Dissecting the transcriptomic basis of phenotypic evolution in the aquatic keystone grazer Daphnia" 

Text from the M&M:

Gene co-expression networks WGCNA
We used the R package WGCNA for weighted correlation network analysis30 to construct gene co-expression networks. The general procedure of WGCNA has been described in detail elsewhere60. In brief, we constructed a signed overall co-expression network using gene expression data15 that assessed transcriptional responses of ancient and modern daphnids exposed to contrasting P regimes. Specifically, we used normalized intensities as input, and limited our analyses to genes that were identified as differentially expressed in one of the tested conditions (FDR < 0.05), using limma61 analysis (for details see15). First, we calculated a similarity co-expression matrix (Pearson’s correlation) for all genes, and transformed these values to an adjacency matrix by using the soft thresholding power (beta = 8), to which co-expression similarity was raised. This step aims to emphasize and reduce the contribution of strong and weak correlations, respectively, on an exponential scale, resulting in a network exhibiting approximate scale-free topology and reduce the noise of the correlations in the adjacency matrix. Next, all genes were hierarchically clustered based on a dissimilarity measure of topological overlap which measures inter-connectedness for a pair of genes60. The resulting gene dendrogram was used for module detection with the Dynamic Tree Cut method (minimum module size = 50, cutting height = 0.9). Gene modules corresponding to the branches cut-off of the gene tree were colour-coded. WGCNA provides a feature to control for genes that cannot be associated with one of the identified expression patterns (the “grey” module), and therefore cannot be placed into any of the existing modules. However, the absence of a grey module in our analysis indicated clear expression patterns throughout the entire dataset. WGCNA further allows for summarizing obtained modules by using eigengenes, which are defined as the first principal component of the expression matrix for each module. Network metrics for individual genes were calculated, including gene significance (i.e., the absolute value of the trait-gene correlation) and module membership (i.e., the module eigengene-gene correlation). Module membership was used to define the top central genes for modules of interest (i.e., hub genes). To assess the contribution of sets of co-expressed genes (i.e., modules), gene expression data was correlated with phenotypic trait data (see above) using the plotDendroAndColors function30. Here, we focus on the two most highly correlated modules per phenotypic trait with a module-trait correlation R2 ≥ |0.4| and a statistical significance of p ≤ 0.005 (for a complete list of trait-module correlations see Fig. S2). 

Preservation network analysis
Module preservation statistics were computed using the modulePreservation function (5000 permutations) implemented in WGCNA49. Network module preservation statistics quantify how density and connectivity patterns of modules defined in a reference data set (here: ancient genotypes) are preserved in a test data set (here: modern genotypes). Network adjacency comparisons are superior estimates of module preservation to standard cross-tabulation techniques. We therefore used network adjacency comparison to assess preservation of gene co-expression patterns in ancient and modern modules. For this, we constructed two networks separately for ancient and modern Daphnia clones. The overall significance of the preservation was assessed using Zsummary and median rank statistics49. Based on the thresholds proposed by Langfelder et al.49, Zsummary < 2 indicates no preservation, 2 < x < 10 weak to moderate evidence of preservation, and >10 strong evidence of module preservation across networks. Median rank statistics further consider module size for preservation assessment49. 

Connection between trait-associated and preservation networks/ modules
In order to assess links between phenotypic divergence, gene-coexpresssion and network preservation, we traced the gene sets of the six focal phenotype modules in modules of the ancient and modern preservation networks. For this, we identified the percentage of genes of a given phenotype module that was present in the modules of the preservation networks (Fig. S6). For closer examination we only chose preservation modules (either the ancient or the modern module of a given colour, or the new yellow module) that contained at least 1/5th of the genes of a phenotype module.  Statistical analyses were performed with the R Statistical Software, version 3.4.1 (R Core Team 2017)62.

Functional enrichment analyses
All predicted protein-coding gene models were functionally assigned to orthologous groups (euKaryotic Orthologous Groups, KOG)63 as defined by the Joint Genome Institute 64. Fisher’s exact tests (P ≤ 0.05) were applied to assess enrichment of up- or down-regulated genes in the different KOG categories. The reference set for statistical testing comprised all genes that . 

Promoter motif analysis
To describe gene regulatory patterns we identified the three most enriched promoter motifs for each phenotype module. We ran a promoter motif analysis with the web-based Daphnia cis-target (http://daphniacistarget.aertslab.org) following Spanier et al14. For the trait-associated network, we used as input the complete gene sets of the six modules most highly correlated with the phenotypic traits RE (purple_RE, brown_RE), bP (tan_bP, greenyellow_bP) and GR (blue_GR, lightgreen_GR). For the preservation networks, we used the gene sets of the three module pairs discussed in this work (ancient and modern bluePres, midnightbluePres, redPres), and the modern yellowPres module.  The promoter analysis was run with default settings and a normalised enrichment score (NES) of 2.5, using the database containing motifs 300 bp upstream of transcription start sites. 

Multivariate analysis of gene expression profiles
Multidimensional scaling (MDS) was used to plot the gene expression profiles of ancient and modern clones in response to high and low P food using the isoMDS() function in the MASS package version 7.3-51.165 for the R Statistical Software, version 3.4.162. Normalised intensities were used to calculate Euclidian distances between all samples.

Linear mixed effects models
To test the linear effects of evolutionary history and phosphorus supply on module eigengene expression, we fitted nested linear mixed effects models with the ‘lme4’ package66 for the R Statistical Software, version 3.4.162.  The dependent variable Module Eigengene (ME) expression was transformed prior to the analysis in order to met the requirements of the linear model. For this, a Box-Cox transformation was performed using the boxcox() function from the MASS package, version 7.3-51.165. Because ME expression values can be both positive and negative, the value 1 was added to all MEs prior to transformation. Models were fitted for the fixed effects of ‘age’ (ancient or modern) and treatment (high or low P food) and their interaction by maximum likelihood (with the ‘REML = FALSE’ argument in the model specification), and the random factor ‘clone’ (4 clones, two modern and two ancient), nested within ‘age’, and compared against a null model that excluded all fixed effects using a likelihood ratio test (ANOVA). 



Visualizations 
Cytoscape v3.6.167, a software environment for integrated models of bimolecular interaction network was employed to visualise network structure of the six most highly correlated trait-associated  modules found in our analysis. The input for cytoscape networks were exported from WGCNA, using the function exportNetworkToCytoscape () of the WGCNA package. Specifically, the cytoscape network was created including only nodes that are connected by edges (intramodular connectivity k) with a weight >0.4, thus reducing complexity of the graph.
Cytoscape v3.6.1 was also used to visualise networks of promoter motif target genes.
Circular plots were created using the circlize package version 0.4.568 for the R Statistical Software, version 3.4.162

